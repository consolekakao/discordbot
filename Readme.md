## 배틀그라운드 전적 검색 봇 노운이



#### ❓ 노운이는 무엇인가요?

> 노운이는 디스코드 봇으로 배틀그라운드 전적을 실시간으로 보기좋게 정리해서 알려주는 봇 입니다.
>
> FPS 게임 특성상 음성 메신저를 주로 사용하기 때문에 디스코드가 가장 유저들이 접근하기 용이하다고 
>
> 생각했기에 디스코드 봇으로 구현하게 되었습니다.



![Demo](https://cdn.discordapp.com/attachments/803197953027866634/809037833762635776/unknown.png)





#### 🥺 왜 노운이를 사용해야하나요?

> 전적 검색사이트를 이용하기 위해선 접속해야하는 번거로움과 모아두었다가 한번에 요청을 처리하는 전적사이트 
>
> 특성상 실시간 데이터를 반영하기 어렵습니다.
>
> 하지만 노운이는 PUBG사로부터 직접 API를 제공받아 경기종료 2분이내로 업데이트 된 데이터를 제공 받습니다.







#### 📕 노운이의 부가 기능은 무엇이 있나요?

> 1. 편리한 전적 검색을 위한 내 아이디 저장  기능
>
>    > 내 아이디를 미리 등록해두면 내전적! 명령어로 내 전적 자동 검색!
>
> 2. 무분별한 도배 방지를 위해 특정 채팅채널에서만 사용가능한 기능
>
>    > 서버장이 선택한 채팅채널에서만 노운이 호출이 가능합니다.
>    >
>    > 다중채널 및 변경기능도 제공됩니다.
>
> 3. 핵쟁이 검색 기능
>
>    > 노운이가 서비스되고 있는 서버들끼리는 불법 프로그램 사용자들의 리스트 공유 및 검색을 제공하고 있습니다.
>    >
>    > 노운이의 서비스 규모가 커질수록 방대한 양의 데이터를 무료로 제공받을 수 있습니다.
>    >
>    > 경쟁전에 예민한 클랜의 경우 리스트 공유의 중요성이 큽니다.
>    >
>    > 아이디 전체를 모르고 일부만 알고있어도 와일드 카드를 통해 검색이 가능합니다.
>    >
>    > 무분별한 의심을 막기위해 3회 이상 신고 접수된 닉네임만 핵쟁이로 표시되며 그 외에는 의심으로 분류됩니다.
>
> 4. 팀 분배 기능
>
>    > 커스텀 매치 등 팀을 나누기위해서 사다리를 타야하고 한명 씩 뽑아야 했던 불편함을 개선하고자 
>    >
>    > 팀 분배 기능이 릴리즈되었습니다. 이제 간단한 명령어로 공평하게 즐기세요.
>
> 5. 연합 서버간 채팅 연동 기능
>
>    > 규모있는 커스텀 경기를 진행하고 싶지만 클랜간 사람을 빼가는 등의 몰상식한 행위로 인해 
>    >
>    > 타 클랜과 교류를 꺼려하는 클랜장들의 걱정을 덜어드리고자 연합 서버간 채팅연동 기능을 지원합니다.
>    >
>    > 각 클랜장끼리 서버ID및 채널ID를 공유하면 각자의 서버에서 지정된 채팅채널에서 메시지 입력시 
>    >
>    > 해당 서버로 노운이가익명으로 대신 전달하는 시스템입니다.  
>    >
>    > 상대 서버에는 내 게임 닉네임만 표기되며 특정 문자열 감지를 통해 멤버 유출등의 행위를 사전 차단 및 
>    >
>    > 관리자들에게 로그를 전송합니다. 다중서버, 다중채널을 지원합니다.



#### 📈 노운이의 사용 현황은 어떻게 되나요?

![API 요청량](https://cdn.discordapp.com/attachments/803197953027866634/809031882318544896/unknown.png)



21년 2월 10일자 기준 서비스 출시 40일만에 12개 서버 29개의 채널에서 서비스 되고 있으며 

1일 평균 100건이상의 요청을 처리하고 있습니다.

피드백을 주기적으로 접수받고 있으며  지속적인 서비스 확장 및 기능구현을 준비하고 있습니다.





------

# 🔧 개발로그



#### 노운이 개발환경

> Back-End : NodeJS / Debian GNU/Linux 10 / Google Cloude platfrom
>
> Batabase : MariaDB 10.x
>
> Use Library : Discord.JS



# 회고



### 개발과정

> 요청이 있었기에 기획이고 뭐고 할거없이 제작부터 들어갔다. 베타 서비스까지 걸린 시간은 1주일.
>
> Discord에서 제공해주는 라이브러리 공문이 꽤나 친절했다. ~~물론 스택오버플로우의 도움을 더 많이 받았지만..~~
>
> 사실 여러 서버로 확장시킬 생각없이 내 서버에서만 사용하려했지만 어쩌다 보니 확장되어 다른 서버까지 
>
> 서비스하게 되었다. 그러다보니 대충 복잡하게 짜둔 코드가 기능 확장시 문제가 되었다.
>
> 명령어를 여러개 만들 계획은 없었기에 비교적 적은 코드로 마무리 지을거라는 착각에 빠져 한 파일에 
>
> 모든 기능을 구현해둔게 화근이 되었다. 따로 분류하는데 하루종일 시간을 투자했던 것 같다. 
>
> 명령어의 Prifix를 맨 앞에 두면 유지보수 측면에서 좋고 개발할때 코드도 훨씬간결해 지지만 사용자들의 
>
> 요구조건에 따라 Prifix는 의미없어지고 결국 명령어를 코드에 하나하나 하드코딩하는 방법을 택했다. 



### 테스트는 힘들다.

> 우선 게임사에서 API를 요청한 값들이 정확한지 확인하기 위해 다양한 아이디를 테스트 해 보아야 하지만 
>
> API요청량이 분당 10회로 리미트 걸려있었고 이 마저도 분할요청 해야했기 때문에 무작정  테스트 해보기엔 
>
> 다소 무리가 있었다. 또 쓸데없이 디테일 하게 값을 줘서 잘라 내느라 애먹었다. 승률 같은 경우 소수점 둘째자리정도만 
>
> 줘도 되는데 열자리 넘게 주는 바람에 타입을 String으로 캐스팅하고 SubString으로 자르고 다시 Number로 캐스팅해서 
>
> 연산해줘야 비로소 원하는 결과가 나온다. 예외처리는 덤이다. FPS에서 Kill / Death를 해야 승률이 나오는데 1킬하고 0데스면 
>
> 킬뎃이 100%가 되어야하는데 1 / 0 은 어쨌던 연산이 불가능해서 무한대가 되기 때문에 문제가 발생한데 그러나 이미 캐스팅하고 
>
> 글자수 잘라내고 하느라 앞에 inf만 출력이 되어서 이게 인피니티라는 것을 깨닫는데 까지 상당한 시간을 허비했다.



### 백엔드는 말할것도 없다.

> "봇은 24시간 항상 서비스되어야한다."는 정신으로 호스팅을 알아보다가 구글클라우드플랫폼(GCP)를  이용했다.
>
> 무중단 배포를 위해 리눅스 환경에서  forever와 pm2를 이용해 무중단배포를 진행했다.
>
> 서비스 초기에 오류가 나서 죽는 경우가 많았고 이걸 pm2가 캐치 못하는 일도 종종 있었기 때문에 강제로 봇을 
>
> 죽였다가 살리는 방안을 택했다. PM2에 cron기능을 이용해 서비스가 자주 죽었던경우에는 10분마다 재실행 시켰고 
>
> 현재는 안정화 단계에 들어서서 30분에 1번씩 재실행 시키는 중이다. 재실행 시간이 2초 이내이기에 서비스에는 지장이 
>
> 없다고 판단했다. 또 백오피스를 웹으로 구현하기위해 Chart.js를 사용해 Nginx에 올렸다. 
>
> GCP를 처음 사용했기에 포트 개방부터 NGINX 세팅 까지 보통일이 아니었지만 어찌어찌 해결했다.



### 익셉션을 만드는 사람들.

> 팀 배정기능을 릴리즈 했지만 오류는 늘 생긴다. 팀 당 인원수를 정하랬더니  2.5를 입력하는 사람이 생겼다.
>
> 당연히 봇은 죽어버렸고 타입이 엄격한 C나 자바가 잠깐 그리웠다.
>
> 자연수만 되게 바꾸는걸로 일단 해결.
>
> 사용 로그를 수집하기 위해 메시지의 컨텐츠를 DB에 등록하는데 컨텐츠에 따옴표나 특정 이스케이프 
>
>  문자를 삽입하는경우 SQL에서 Syntax 오류를 뱉었다. 이 역시 정규식을 활용해서 전역에 Replace 처리해줬다.



### 단순 기능구현과 서비스 운영은 느낌부터 다르다.

> 아직  대규모는 아니지만 다양한 사람들이 다양한 시간대에 사용을 하고있다 보니 안정적이게 서비스를 구동시킬
>
> 필요성이 매우 컸다. 코드상에는 문제가 없었지만 트래픽이 몰릴때 어떻게 처리 해줘야 할 지 고민도 필요했고
>
> 로컬 환경에서 구동하는 게 아니다보니 바로 실시간 코드 수정도 시간이 소요되고 문제점 파악을 위해 로그파일도
>
> 필요했기에 이 역시 봇 명령어로 로그 작성파일을 채팅방에 올려주는 식으로 원인 파악을 시도했다.
>
> 봇에 문제가 발생시 로그가 메일로 알람이 오게 하려고 NodeMailer를 활용했다. 
>
> ~~(초기엔 너무 많은 에러로 인해 스팸으로 분류되었다.)~~ 
>
> 그래도 많은 사람들이 내가 개발한 서비스를 실제로 이용하고 있다 생각하니 뿌듯하고 기쁜 한편 어떻게 하면
>
> 안정적으로 서비스 할 수 있을지 항상 고민을 달고 살게되었다.
>
> 그치만 실제로 운영하면서 이젠 나 혼자 고민하는 게 아닌 사용자들의 피드백이 곧 나의 아이디어가 되고
>
> 사용자들과 함께 서비스를 발전시켜 나간다 생각하니 뿌듯하다.



### 추후계획

> 급하게 짜느라 스파게티가 되어버린 내 코드들을 재정비 후 언어를  JS가 아닌 JAVA나 Python으로 구동 시켜보고
>
> 서버도 이번엔 구글 클라우드 플랫폼을 이용했지만 AWS를 사용해서 서비스 해 볼 예정이다.
>
> PUBG 게임이 아닌 다른 게임이 될 수도 있지만 FPS 위주로 될 것 같다.
>
> 이번에 개발 한 봇은 실 서비스 하고 있는 이상 지속적인 업데이트와 유지보수는 지원 할 계획이다.